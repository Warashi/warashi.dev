<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>Signed HTTP Exchanges (SXG) と Accelerated Mobile Pages (AMP)</title>
<meta name=description content="まだDraftなんですが、 Signed HTTP Exchanges という規格があります。規格そのものについて詳しくはJxckさんのブログ記事 WebPackaging の Signed HTTP Exchanges を参照してもらえるといいと思います。
"><meta name=keywords content><meta property="og:url" content="https://warashi.dev/posts/a1f6a656-dea7-42e4-8355-d9fc056c7ccf/"><meta property="og:type" content="website"><meta property="og:title" content="Signed HTTP Exchanges (SXG) と Accelerated Mobile Pages (AMP)"><meta property="og:description" content="まだDraftなんですが、 Signed HTTP Exchanges という規格があります。規格そのものについて詳しくはJxckさんのブログ記事 WebPackaging の Signed HTTP Exchanges を参照してもらえるといいと思います。
"><meta property="og:image" content="https://warashi.dev/images/tisza.png"><meta property="og:image:secure_url" content="https://warashi.dev/images/tisza.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Signed HTTP Exchanges (SXG) と Accelerated Mobile Pages (AMP)"><meta name=twitter:description content="まだDraftなんですが、 Signed HTTP Exchanges という規格があります。規格そのものについて詳しくはJxckさんのブログ記事 WebPackaging の Signed HTTP Exchanges を参照してもらえるといいと思います。
"><meta property="twitter:domain" content="https://warashi.dev/posts/a1f6a656-dea7-42e4-8355-d9fc056c7ccf/"><meta property="twitter:url" content="https://warashi.dev/posts/a1f6a656-dea7-42e4-8355-d9fc056c7ccf/"><meta name=twitter:image content="https://warashi.dev/images/tisza.png"><link rel=canonical href=https://warashi.dev/posts/a1f6a656-dea7-42e4-8355-d9fc056c7ccf/><link rel=stylesheet type=text/css href=https://warashi.dev/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=https://warashi.dev/css/main.min.css><link id=dark-theme rel=stylesheet href=https://warashi.dev/css/dark.min.css><script src=https://warashi.dev/js/bundle.min.a036ebe92c17ea3f0c07761c2135b82bec6f37c8efb7f49ddad1f28c22fc4769.js integrity="sha256-oDbr6SwX6j8MB3YcITW4K+xvN8jvt/Sd2tHyjCL8R2k="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://warashi.dev/><img src=https://warashi.dev/images/tisza.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://warashi.dev/>404 やる気 Not Found</a></div><div class=nav-links><div class=nav-link><a href=https://warashi.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://warashi.dev/about/ aria-label><span data-feather=smile></span> About</a></div><div class=nav-link><a href=https://warashi.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://times.warashi.dev/ aria-label><span data-feather=hash></span> times-warashi</a></div><div class=nav-link><a href=https://warashi.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://warashi.dev/index.xml aria-label><span data-feather=rss></span> Feed</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://warashi.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://warashi.dev/about/><span data-feather=smile></span> About</a></li><li class=nav-item><a href=https://warashi.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://times.warashi.dev/><span data-feather=hash></span> times-warashi</a></li><li class=nav-item><a href=https://warashi.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://warashi.dev/index.xml><span data-feather=rss></span> Feed</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Signed HTTP Exchanges (SXG) と Accelerated Mobile Pages (AMP)</h1><small role=doc-subtitle></small><p class=post-date>2019-03-16</p><ul class=post-tags></ul></div><div class=post-content><p>まだDraftなんですが、 Signed HTTP Exchanges という規格があります。規格そのものについて詳しくはJxckさんのブログ記事 <a href=https://blog.jxck.io/entries/2018-12-01/signed-http-exchanges.html>WebPackaging の Signed HTTP Exchanges</a> を参照してもらえるといいと思います。</p><p>この応用先として、Accelerated Mobile Pages (AMP)を表示する際にオリジナルのURLで表示するというものがあります。SXGを使わない（この記事執筆時点での一般的な状態）のAMPはGoogleだったりAMPProjectのドメインで配信されているはずです。これを、SXGをうまく使ってやることで配信はGoogleなどのAMPキャッシュから行うが、ブラウザのURLバーに表示するのはオリジナルのURLにするということが実現できます。</p><p>これを実現するためには、Google Botがクロールしに来た時にSXGがあるということを伝えてやったり、実際にSXGを生成して返してやる必要があります。そのための<a href=https://github.com/ampproject/amppackager><strong>AMP Packager</strong> というツール</a>がAMP Projectによって公開されています。</p><p>今回、origin、AMP Packagerと、必要に応じてAMP Packagerにアクセスを向けるReverse Proxyの3つをdocker-composeでローカルで動かして動作確認するということをやったのでそれについて解説したいと思います。</p><p>AMP PackagerのREADMEにも書いてありますが、Reverse Proxyでの処理は下記のようになります。</p><ol><li><code>/amppkg/</code> 以下はそのままAMP Packagerに向ける</li><li>リクエストに <code>AMP-Cache-Transform</code> ヘッダがある場合は <code>/priv/doc/$scheme://$server_name$request_uri</code> にrewriteしてAMP Packagerに向ける<ul><li><code>/priv/doc/</code> 以下に直接アクセスがあった場合にはAMP Packagerに向け <strong>ない</strong></li></ul></li><li>その他のリクエストはそのままOriginに向ける</li></ol><p>また、その他の注意点として、AMPページに対する最終的なレスポンスの <code>Vary</code> ヘッダーに <code>AMP-Cache-Transform</code> と <code>Accept</code> を入れてやる必要があります。</p><p>それ以外に今回はまったポイントがあるんですが、それはオレオレ証明書を使っていることが原因でした。具体的には</p><ol><li>AMP Packagerが使う証明書にはOCSP Serverの情報がないこと。</li><li>AMP PackagerからOriginへのfetchがHTTPSで行われる際の証明書エラーが起きる。</li><li>Chromeに起動オプションを渡してやらないと証明書エラーが起きる。</li></ol><p>それぞれ、下記で解決できました。</p><ol><li><p>amppkgコマンドを実行する前にopensslコマンドでocsp responseを生成してやる。このときopensslコマンドの出力先に、amppkg.tomlで指定したOCSP Cacheのパスを指定する。コマンドは下記。</p><div class=highlight><div style=color:#c6d0f5;background-color:#303446;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#838ba7" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#838ba7" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>touch index.txt index.txt.attr
</span></span><span style=display:flex><span>openssl ocsp -noverify -index ./index.txt -rsigner ca.ocsp.cert -rkey ca.privkey -CA ca.cert -ndays <span style=color:#ef9f76>7</span> -issuer ca.cert -cert server.cert -respout /tmp/amppkg-ocsp
</span></span></code></pre></td></tr></table></div></div></li><li><p>オレオレ認証局の証明書をあらかじめシステムに登録してやる。</p></li><li><p>Chromeの起動オプション <code>--ignore-certificate-errors-spki-list</code> にカンマ区切りで証明書の情報を渡してやる。</p><ul><li>渡す情報は各証明書（ <code>server.cert</code> ）に対して下記コマンドで取得できる。渡す必要があるのは、TLSに使う証明書とSXGに使う証明書の2つ。</li></ul><div class=highlight><div style=color:#c6d0f5;background-color:#303446;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#838ba7" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat server.cert | openssl x509 -pubkey | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | base64
</span></span></code></pre></td></tr></table></div></div></li></ol><p>使ったコードは <a href=https://github.com/Warashi/try-amppackager>https://github.com/Warashi/try-amppackager</a> で公開していますのでぜひ参考にしてください。</p></div><div class=prev-next></div></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>